name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build and test
        run: mvn verify -DskipITs -DskipIntegrationTests=true -Pskip-frontend

      - name: Unit test summary
        if: always()
        run: |
          echo "## Unit Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          total_passed=0; total_failed=0; total_errors=0; total_skipped=0
          found=0; failure_details=""

          # Collect per-class results
          rows=""
          for report in $(find . -path '*/surefire-reports/*.xml' -name 'TEST-*.xml' 2>/dev/null | sort); do
            # Extract attributes from <testsuite> tag using sed
            name=$(sed -n 's/.*<testsuite[^>]* name="\([^"]*\)".*/\1/p' "$report" | head -1)
            t=$(sed -n 's/.*<testsuite[^>]* tests="\([0-9]*\)".*/\1/p' "$report" | head -1)
            f=$(sed -n 's/.*<testsuite[^>]* failures="\([0-9]*\)".*/\1/p' "$report" | head -1)
            e=$(sed -n 's/.*<testsuite[^>]* errors="\([0-9]*\)".*/\1/p' "$report" | head -1)
            s=$(sed -n 's/.*<testsuite[^>]* skipped="\([0-9]*\)".*/\1/p' "$report" | head -1)
            time=$(sed -n 's/.*<testsuite[^>]* time="\([^"]*\)".*/\1/p' "$report" | head -1)

            t=${t:-0}; f=${f:-0}; e=${e:-0}; s=${s:-0}; time=${time:-0}
            p=$((t - f - e - s))

            # Determine icon
            if [ $((f + e)) -gt 0 ]; then
              icon=":x:"
            elif [ "$s" -gt 0 ] && [ "$t" -eq "$s" ]; then
              icon=":fast_forward:"
            else
              icon=":white_check_mark:"
            fi

            # Short class name (strip package)
            short_name="${name##*.}"

            # Module from path
            module=$(echo "$report" | sed 's|^\./\(.*\)/target/.*|\1|' | sed 's|/|-|g')

            rows="${rows}| ${icon} | ${module} | ${short_name} | ${t} | ${p} | ${f} | ${e} | ${s} | ${time}s |\n"

            # Extract individual failure/error details
            if [ $((f + e)) -gt 0 ]; then
              details=$(awk '
                /<testcase / {
                  match($0, /name="([^"]*)"/, m); method = m[1]
                }
                /<failure / {
                  match($0, /message="([^"]*)"/, mm); fmsg = mm[1]
                  match($0, /type="([^"]*)"/, mt); ftype = mt[1]
                  # Short type name
                  sub(/.*\./, "", ftype)
                  printf "| :x: | `%s` | `%s` | %s | %s |\n", method, ftype, "FAILURE", fmsg
                }
                /<error / {
                  match($0, /message="([^"]*)"/, mm); emsg = mm[1]
                  match($0, /type="([^"]*)"/, mt); etype = mt[1]
                  sub(/.*\./, "", etype)
                  printf "| :x: | `%s` | `%s` | %s | %s |\n", method, etype, "ERROR", emsg
                }
              ' "$report")
              if [ -n "$details" ]; then
                failure_details="${failure_details}<details>\n<summary>:x: <b>${module}</b> / ${short_name} (${f} failures, ${e} errors)</summary>\n\n"
                failure_details="${failure_details}| | Method | Exception | Type | Message |\n"
                failure_details="${failure_details}|---|--------|-----------|------|---------|\n"
                failure_details="${failure_details}${details}\n\n"
                failure_details="${failure_details}</details>\n\n"
              fi
            fi

            total_passed=$((total_passed + p))
            total_failed=$((total_failed + f))
            total_errors=$((total_errors + e))
            total_skipped=$((total_skipped + s))
            found=$((found + 1))
          done

          total=$((total_passed + total_failed + total_errors + total_skipped))

          if [ $found -gt 0 ]; then
            echo "| | Module | Test Class | Tests | Passed | Failed | Errors | Skipped | Duration |" >> $GITHUB_STEP_SUMMARY
            echo "|---|--------|------------|-------|--------|--------|--------|---------|----------|" >> $GITHUB_STEP_SUMMARY
            printf "$rows" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ $((total_failed + total_errors)) -eq 0 ]; then
              echo "> **All $total tests passed** ($found test classes) :white_check_mark:" >> $GITHUB_STEP_SUMMARY
            else
              echo "> **$total_failed failed, $total_errors errors** out of $total tests ($found test classes) :x:" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Failed Tests" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              printf "$failure_details" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "No unit test results found." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: '**/target/surefire-reports/'
          retention-days: 7

  integration-tests:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build uber JARs
        run: mvn package -DskipTests -Pskip-frontend

      - name: Make scripts executable
        run: chmod +x run-*.sh

      - name: Run reference tests
        id: ref-tests
        run: |
          ./run-reference-test.sh all 2>&1 | tee reference-test-output.txt
          exit ${PIPESTATUS[0]}

      - name: Run session tests
        id: session-tests
        if: success() || failure()
        run: |
          ./run-session-test.sh all text 2>&1 | tee session-test-output.txt
          exit ${PIPESTATUS[0]}

      - name: Test results summary
        if: always()
        run: |
          echo "## Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # --- Reference Tests ---
          echo "### Reference Tests (QuickFIX/J)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f reference-test-output.txt ]; then
            echo "| | Test | Validates | Result | Details |" >> $GITHUB_STEP_SUMMARY
            echo "|---|------|-----------|--------|---------|" >> $GITHUB_STEP_SUMMARY
            # Parse result lines and the "Validates:" line that follows each test
            # Format: "  âœ“ PASS  TestName                     Message"
            #         "          Validates: description text"
            awk '
              {
                for (i = 1; i <= NF; i++) {
                  if ($i == "PASS" || $i == "FAIL" || $i == "ERROR" || $i == "SKIP") {
                    status = $i
                    testname = $(i+1)
                    if (testname ~ /Test/) {
                      msg = ""
                      for (j = i+2; j <= NF; j++) msg = msg (j>i+2?" ":"") $j
                      if (status == "PASS") icon = ":white_check_mark:"
                      else if (status == "FAIL") icon = ":x:"
                      else if (status == "ERROR") icon = ":warning:"
                      else icon = ":fast_forward:"
                      # Read next line for Validates:
                      if ((getline nextline) > 0 && nextline ~ /Validates:/) {
                        desc = nextline
                        sub(/.*Validates:[[:space:]]*/, "", desc)
                      } else {
                        desc = ""
                      }
                      printf "| %s | %s | %s | **%s** | %s |\n", icon, testname, desc, status, msg
                    }
                    break
                  }
                }
              }
            ' reference-test-output.txt >> $GITHUB_STEP_SUMMARY
            # Summary line
            summary=$(grep -E '^Total:' reference-test-output.txt || true)
            if [ -n "$summary" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "> $summary" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo ":warning: Reference tests did not run." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # --- Session Tests ---
          echo "### Session Tests (OmniBridge Engine)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f session-test-output.txt ]; then
            echo "| | Test | Validates | Result | Duration | Details |" >> $GITHUB_STEP_SUMMARY
            echo "|---|------|-----------|--------|----------|---------|" >> $GITHUB_STEP_SUMMARY
            # Parse blocks: test name, Validates, Status, Duration, Message lines
            awk '
              /^\[.*\] / {
                testname = $0
                sub(/^\[.*\] /, "", testname)
                desc = ""
              }
              /^[[:space:]]+Validates:/ {
                desc = $0
                sub(/^[[:space:]]+Validates:[[:space:]]+/, "", desc)
              }
              /^[[:space:]]+Status:/ {
                status = $NF
              }
              /^[[:space:]]+Duration:/ {
                duration = ""
                for(i=2;i<=NF;i++) duration = duration (i>2?" ":"") $i
              }
              /^[[:space:]]+Message:/ {
                msg = $0
                sub(/^[[:space:]]+Message:[[:space:]]+/, "", msg)
                if (status == "PASSED") icon = ":white_check_mark:"
                else if (status == "FAILED") icon = ":x:"
                else if (status == "ERROR") icon = ":warning:"
                else if (status == "SKIPPED") icon = ":fast_forward:"
                else icon = ":grey_question:"
                printf "| %s | %s | %s | **%s** | %s | %s |\n", icon, testname, desc, status, duration, msg
              }
            ' session-test-output.txt >> $GITHUB_STEP_SUMMARY
            # Summary line
            if grep -q "ALL TESTS PASSED" session-test-output.txt; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "> **All session tests passed** :white_check_mark:" >> $GITHUB_STEP_SUMMARY
            elif grep -q "SOME TESTS FAILED" session-test-output.txt; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "> **Some session tests failed** :x:" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo ":warning: Session tests did not run." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload acceptor logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-logs
          path: '*.log'
          retention-days: 7
